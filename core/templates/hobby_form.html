{% extends 'base.html' %}

{% block content %}
<!-- Tagify CSS -->
<link href="https://unpkg.com/@yaireo/tagify/dist/tagify.css" rel="stylesheet" type="text/css" />

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body p-4 p-md-5">
                <h2 class="card-title text-center mb-4">Create a New Hobby</h2>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">{{ form.title.label_tag }} {{ form.title }}</div>
                    <div class="mb-3">{{ form.description.label_tag }} {{ form.description }}</div>
                    <div class="mb-3">{{ form.image.label_tag }} {{ form.image }}</div>
                    
                    <div class="row g-3">
                        <div class="col-md-6 mb-3">{{ form.category.label_tag }} {{ form.category }}</div>
                        <div class="col-md-6 mb-3">{{ form.tags.label_tag }} {{ form.tags }}</div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-4 mb-3">{{ form.max_participants.label_tag }} {{ form.max_participants }}</div>
                        <div class="col-md-4 mb-3">{{ form.date.label_tag }} {{ form.date }}</div>
                        <div class="col-md-4 mb-3">{{ form.place.label_tag }} {{ form.place }}</div>
                    </div>

                    <!-- Requirements Section -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Requirements (Optional)</label>
                        <div id="requirements-list" class="mb-2"></div>
                        <button type="button" id="add-requirement" class="btn btn-sm btn-outline-secondary">Add Requirement</button>
                    </div>
                    {{ form.requirements }}

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">Post Hobby</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tagify JS -->
<script src="https://unpkg.com/@yaireo/tagify"></script>
<script src="https://unpkg.com/@yaireo/tagify/dist/tagify.polyfills.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Script for Category Autocomplete
    const categoryInput = document.querySelector('#{{ form.category.id_for_label }}');
    fetch("{% url 'get_categories' %}")
        .then(response => response.json())
        .then(whitelist => {
            new Tagify(categoryInput, {
                whitelist: whitelist,
                maxTags: 1,
                dropdown: {
                    maxItems: 20,
                    enabled: 0,
                    closeOnSelect: true
                }
            });
        });

    // Script for Tags Autocomplete
    const tagsInput = document.querySelector('#{{ form.tags.id_for_label }}');
    fetch("{% url 'get_tags' %}")
        .then(response => response.json())
        .then(whitelist => {
            new Tagify(tagsInput, {
                whitelist: whitelist,
                dropdown: {
                    maxItems: 20,
                    enabled: 0,
                    closeOnSelect: false
                }
            });
        });

    // Requirements script
    const addReqBtn = document.getElementById('add-requirement');
    const reqList = document.getElementById('requirements-list');
    const form = document.querySelector('form');
    const hiddenReqInput = document.querySelector('[name="requirements"]');

    addReqBtn.addEventListener('click', () => {
        const reqRow = document.createElement('div');
        reqRow.classList.add('input-group', 'mb-2');
        reqRow.innerHTML = `
            <input type="text" class="form-control requirement-name" placeholder="Requirement name (e.g., Tent)">
            <div class="input-group-text">
                <input class="form-check-input mt-0 requirement-provided" type="checkbox" title="Check if you are providing this">
                <label class="ms-2">I'll provide</label>
            </div>
            <button type="button" class="btn btn-outline-danger remove-requirement">Remove</button>
        `;
        reqList.appendChild(reqRow);
    });

    reqList.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-requirement')) {
            e.target.closest('.input-group').remove();
        }
    });

    form.addEventListener('submit', (e) => {
        const requirements = [];
        document.querySelectorAll('#requirements-list .input-group').forEach(row => {
            const name = row.querySelector('.requirement-name').value.trim();
            const provided = row.querySelector('.requirement-provided').checked;
            if (name) {
                requirements.push({ name, provided });
            }
        });
        hiddenReqInput.value = JSON.stringify(requirements);
    });
});
</script>

<style>
    /* Improve form rendering */
    input[type='text'], input[type='number'], textarea, select, input[type='datetime-local'] {
        display: block;
        width: 100%;
        padding: .375rem .75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid #ced4da;
        border-radius: .25rem;
    }
    textarea { min-height: 120px; }
    .tagify {
        width: 100%;
        border: 1px solid #ced4da;
    }
</style>
{% endblock %}